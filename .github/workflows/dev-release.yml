name: Dev Release

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  check:
    name: Check and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

      - name: Build all features
        run: cargo build --all-features --release

  tag-dev:
    name: Create Dev Tag
    needs: check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          DEV_TAG="v${VERSION}-dev.${COMMIT_SHORT}"
          echo "tag=${DEV_TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create or update dev tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          # Delete tag if it exists (locally and remotely)
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true

          # Create new tag
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Create release notes
          cat > release_notes.md << EOF
          # ðŸš€ Development Release ${VERSION}

          **This is a development release** - Use for testing only!

          ## ðŸ“¦ Using this dev release

          Add this to your \`Cargo.toml\`:

          \`\`\`toml
          [dependencies]
          lighty-launcher = { git = "https://github.com/Lighty-Launcher/LightyLauncherLib", tag = "${TAG}", features = ["tauri-commands", "events"] }
          \`\`\`

          Or for a specific branch:

          \`\`\`toml
          [dependencies]
          lighty-launcher = { git = "https://github.com/Lighty-Launcher/LightyLauncherLib", branch = "dev", features = ["tauri-commands", "events"] }
          \`\`\`

          ## ðŸ“ Commit

          \`$(git log -1 --pretty=format:'%h - %s (%an)')\`

          ---

          For stable releases, use the version from [crates.io](https://crates.io/crates/lighty-launcher)
          EOF

          # Delete existing release if it exists
          gh release delete "$TAG" -y 2>/dev/null || true

          # Create new release
          gh release create "$TAG" \
            --title "Dev Release ${VERSION} (${TAG})" \
            --notes-file release_notes.md \
            --prerelease \
            --target dev
